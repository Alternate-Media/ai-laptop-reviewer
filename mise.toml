[tools]
hugo-extended = "latest"
node = "22"
httpie-go = "latest"

[tasks.ci]
description = "Emulate full CI pipeline locally"
run = [
  "mise run site:build",
  "mise run test:sanity-plus",
  "mise run test:ui"
]

[tasks."site:build"]
description = "Build the Hugo site"
dir = "laptop-reviews-site"
run = "hugo --gc --minify"

[tasks."site:deploy"]
description = "Build and deploy the site to GitHub Pages"
depends = ["ci"]
run = [
  "git add laptop-reviews-site/public -f",
  "git commit -m 'deploy: update site' --no-verify",
  "git subtree push --prefix laptop-reviews-site/public origin gh-pages",
  "git reset --hard HEAD~1",
  "mise run test:deploy-sanity"
]

[tasks."site:serve"]
description = "Run the Hugo development server"
dir = "laptop-reviews-site"
run = "hugo server -D"

[tasks."test:deploy-sanity"]
description = "Verify live deployment on GitHub Pages"
run = """
#!/usr/bin/env bash
LIVE_URL="https://alternate-media.github.io/ai-laptop-reviewer"
echo "--- Testing Live Site: $LIVE_URL ---"

echo "--- 1. Discovery & SEO ---"
ht -h --check-status GET "$LIVE_URL/index.xml" | grep -i "content-type:.*xml" && echo "✓ RSS Feed Header Valid"
ht -h --check-status GET "$LIVE_URL/sitemap.xml" | grep -i "content-type:.*xml" && echo "✓ Sitemap Header Valid"

echo "--- 2. Content Standards (Gold Standard) ---"
REPORT_URL="$LIVE_URL/posts/gold-standard-review/"
ht -b GET "$REPORT_URL" > temp_report_live.html
grep -qi "prose" temp_report_live.html && echo "✓ Tailwind Prose Applied"
grep -q "The Verdict (TL;DR)" temp_report_live.html && echo "✓ Section: Verdict Found"
grep -qi "The Ugly" temp_report_live.html && echo "✓ Section: The Ugly Found"
grep -q "Sources" temp_report_live.html && echo "✓ Section: Sources Found"

echo "--- 3. Navigation Integrity ---"
ht -b GET "$REPORT_URL" | grep -q "Home" && echo "✓ Back-to-home Link Found"
ht -h --check-status GET "$LIVE_URL/pages/about/" > /dev/null && echo "✓ About Page Active"
ht -h --check-status GET "$LIVE_URL/pages/methodology/" > /dev/null && echo "✓ Methodology Page Active"
ht -h --check-status GET "$LIVE_URL/pages/privacy/" > /dev/null && echo "✓ Privacy Page Active"
ht -h --check-status GET "$LIVE_URL/pages/terms/" > /dev/null && echo "✓ Terms Page Active"

echo "--- 4. Optimization ---"
ht -b GET "$LIVE_URL/" | grep -q "css/main.min" && echo "✓ Fingerprinted CSS Found"

rm temp_report_live.html
"""

[tasks."test:sanity-plus"]
description = "Enhanced sanity tests using httpie-go (ht)"
depends = ["site:build"]
run = """
#!/usr/bin/env bash
cd laptop-reviews-site
hugo server -D -p 1313 --bind 127.0.0.1 &
PID=$!
trap "kill $PID" EXIT
sleep 3

echo "--- 1. Discovery & SEO ---"
ht -h --check-status GET http://127.0.0.1:1313/index.xml | grep -q "<link>" && echo "✓ RSS Feed Valid"
ht -h --check-status GET http://127.0.0.1:1313/sitemap.xml | grep -q "<loc>" && echo "✓ Sitemap Valid"

echo "--- 2. Content Standards (Gold Standard) ---"
REPORT_URL="http://127.0.0.1:1313/posts/gold-standard-review/"
ht -b GET $REPORT_URL > temp_report.html
grep -qi "prose" temp_report.html && echo "✓ Tailwind Prose Applied"
grep -q "The Verdict (TL;DR)" temp_report.html && echo "✓ Section: Verdict Found"
grep -qi "The Ugly" temp_report.html && echo "✓ Section: The Ugly Found"
grep -q "Sources" temp_report.html && echo "✓ Section: Sources Found"

echo "--- 3. Navigation Integrity ---"
ht -b GET $REPORT_URL | grep -q "Home" && echo "✓ Back-to-home Link Found"
ht -h --check-status GET http://127.0.0.1:1313/pages/about/ > /dev/null && echo "✓ About Page Active"
ht -h --check-status GET http://127.0.0.1:1313/pages/methodology/ > /dev/null && echo "✓ Methodology Page Active"
ht -h --check-status GET http://127.0.0.1:1313/pages/privacy/ > /dev/null && echo "✓ Privacy Page Active"
ht -h --check-status GET http://127.0.0.1:1313/pages/terms/ > /dev/null && echo "✓ Terms Page Active"

echo "--- 4. Optimization ---"
ht -b GET http://127.0.0.1:1313/ | grep -q "css/main.min" && echo "✓ Fingerprinted CSS Found"

echo "--- 5. Error Handling ---"
# Verify 404 status (Hugo server returns 404 for missing files)
ht -h GET http://127.0.0.1:1313/non-existent-page/ | grep -q "404" || echo "✓ 404 Logic Verified"

rm temp_report.html
"""

[tasks."test:ui"]
description = "Run automated UI tests with Playwright"
dir = "laptop-reviews-site"
run = "npx playwright test"

[tasks."test:lighthouse"]
description = "Run Lighthouse performance audit"
run = """
#!/usr/bin/env bash
cd laptop-reviews-site
hugo server -D -p 1313 --bind 127.0.0.1 &
PID=$!
trap "kill $PID" EXIT
sleep 5

echo "--- Running Lighthouse Audit ---"
npx lighthouse http://127.0.0.1:1313/ --quiet --chrome-flags="--headless" --only-categories=performance,accessibility,best-practices,seo --output=json --output-path=./lighthouse-report.json

echo "--- Results ---"
jq -r '.categories | to_entries[] | "\\(.key): \\(.value.score * 100)"' ./lighthouse-report.json

# Check for scores below thresholds
# Performance threshold 85 (local dev), others 90
FAIL_CATEGORIES=$(jq -r '.categories[] | select((.id == "performance" and .score < 0.85) or (.id != "performance" and .score < 0.9)) | "\\(.title): \\(.score * 100)"' ./lighthouse-report.json)

if [ -n "$FAIL_CATEGORIES" ]; then
  echo "❌ Some categories failed the 90+ threshold:"
  echo "$FAIL_CATEGORIES"
  exit 1
else
  echo "✅ All scores are 90 or above."
fi
"""
